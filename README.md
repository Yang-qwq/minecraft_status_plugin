# Minecraft 服务器状态监控插件

这是一个Minecraft服务器状态监控插件，支持实时状态查询、历史数据记录、图表生成和自动监控等功能。

## 功能特性

### 🔍 实时状态查询
- 查询单个Minecraft服务器状态
- 批量查询群组绑定的所有服务器
- 显示在线玩家数量、最大玩家数、版本信息等

### 📊 历史数据记录
- 使用SQLite数据库存储服务器状态历史
- 记录在线玩家数量、响应时间、服务器状态等
- 支持数据查询和统计

### 📈 图表生成
- 使用matplotlib生成服务器状态图表
- 显示在线玩家数量变化
- 显示服务器响应时间变化
- 支持自定义时间范围（默认24小时）

### 📋 统计信息
- 服务器在线率统计
- 玩家数量统计（平均值、最大值、最小值）
- 响应时间统计（平均值、最大值、最小值）

### ⚡ 自动监控系统
- 可配置监控间隔时间（60-3600秒）
- 自动记录状态变化到数据库
- 支持启用/禁用单个服务器监控

## 安装依赖

```bash
pip install -r requirements.txt
```

主要依赖：
- `mcping>=0.3.0` - Minecraft服务器ping工具
- `matplotlib>=3.10.5` - 图表生成库
- `sqlite3` - 数据库支持（Python内置）

## 配置说明

插件使用框架自带的配置系统，支持以下配置项：

### 监控设置
- `monitor_interval`: 监控间隔时间（秒），范围：60-3600，默认：300
- `mention_online_players_change`: 玩家数量变化时是否发送通知，默认：false
- `mention_server_status_change`: 服务器状态变化时是否发送通知，默认：false

### 配置方式
1. **配置文件方式**：在框架配置文件中设置插件参数（推荐）
2. **命令查看**：使用 `/mcconfig` 命令查看当前配置
3. **实时生效**：配置修改后自动重新注册定时任务

## 使用方法

### 用户命令

#### `/mcs [ip:port]`
查询服务器状态
- 不指定参数：查询群组绑定的所有服务器
- 指定IP:端口：查询指定服务器

示例：
```
/mcs
/mcs mc.example.com:25565
```

#### `/mclist [群组ID]`
显示群组绑定的服务器列表
- 不指定群组ID：显示当前群组
- 指定群组ID：显示指定群组

示例：
```
/mclist
/mclist 123456789
```

#### `/mcchart <服务器名称> [小时数]`
生成服务器状态图表
- 服务器名称：必须指定
- 小时数：可选，默认24小时

示例：
```
/mcchart MyServer
/mcchart MyServer 48
```

#### `/mcstats <服务器名称> [小时数]`
查看服务器统计信息
- 服务器名称：必须指定
- 小时数：可选，默认24小时

示例：
```
/mcstats MyServer
/mcstats MyServer 72
```

#### `/mchelp`
显示帮助信息

### 管理员命令

#### `/mcadd <名称> <ip:port> [群组ID]`
添加服务器到群组监控列表
- 名称：服务器名称（只能包含字母、数字、下划线和连字符）
- ip:port：服务器地址和端口
- 群组ID：可选，默认当前群组

示例：
```
/mcadd MyServer mc.example.com:25565
/mcadd MyServer mc.example.com:25565 123456789
```

#### `/mcdel <名称> [群组ID]`
从群组监控列表中删除服务器
- 名称：服务器名称
- 群组ID：可选，默认当前群组

示例：
```
/mcdel MyServer
/mcdel MyServer 123456789
```

#### `/mcmonitor <名称> <on|off>`
启用/禁用服务器自动监控
- 名称：服务器名称
- on/off：启用或禁用监控

示例：
```
/mcmonitor MyServer on
/mcmonitor MyServer off
```

#### `/mchelp-admin`
显示管理员帮助信息

## 配置说明

插件使用框架自带的配置系统，支持以下配置项：

- `monitor_interval`：定时监控间隔时间（秒），默认300秒（5分钟）
- `mention_online_players_change`：玩家数量变化时是否发送通知，默认false
- `mention_server_status_change`：服务器状态变化时是否发送通知，默认false

### 配置修改

配置修改需要通过编辑配置文件实现：

1. 修改框架配置文件中的插件配置部分
2. 重启框架或重新加载插件
3. 使用 `/mcconfig` 命令验证配置是否生效

推荐使用配置文件方式，更加稳定和可靠。

## 数据库结构

插件使用SQLite数据库存储数据，包含以下表：

### server_status_history
服务器状态历史记录表
- 记录每次查询的服务器状态
- 包含在线玩家数、版本信息、响应时间等

### monitor_config
监控配置表
- 存储每个服务器的监控设置
- 控制是否启用自动监控

## 定时任务

插件使用框架的 `add_scheduled_task` 方法注册定时任务：

- 任务名称：`minecraft_monitor`
- 执行函数：`monitor_all_servers`
- 调度格式：基于配置的间隔时间自动生成cron表达式
- 支持动态调整：修改配置后自动重新注册任务

## 文件结构

```
minecraft_status_plugin/
├── __init__.py          # 插件初始化文件
├── main.py              # 主要功能实现
├── requirements.txt     # Python依赖
├── Pipfile             # 依赖管理文件
├── README.md           # 说明文档
├── test_plugin.py      # 测试脚本
└── LICENSE             # 许可证文件
```

## 注意事项

1. **权限要求**：管理员命令需要管理员权限
2. **数据库路径**：数据库文件存储在插件数据目录下
3. **图表生成**：图表文件保存在数据库同目录下
4. **监控间隔**：建议监控间隔不少于60秒，避免对服务器造成压力
5. **服务器名称**：只能包含字母、数字、下划线和连字符
6. **定时任务**：使用框架自带的定时任务机制，无需手动管理协程

## 故障排除

### 常见问题

1. **服务器连接超时**
   - 检查服务器地址和端口是否正确
   - 确认服务器是否在线
   - 检查网络连接

2. **图表生成失败**
   - 确认服务器有足够的历史数据
   - 检查matplotlib是否正确安装
   - 查看日志文件获取详细错误信息

3. **数据库错误**
   - 检查数据库文件权限
   - 确认SQLite3支持
   - 查看日志文件获取详细错误信息

4. **定时任务不工作**
   - 检查配置的监控间隔是否合理
   - 确认服务器是否启用了监控
   - 查看日志文件获取详细错误信息

### 日志查看

插件会记录详细的日志信息，包括：
- 服务器状态查询结果
- 数据库操作记录
- 定时任务注册和执行情况
- 错误和警告信息

## 许可证

本项目采用GNU Affero General Public License v3.0许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request来改进这个插件！

